#!/usr/bin/env bash
#MISE description="Test that extract-changelog correctly extracts version sections"
set -euo pipefail

echo "Testing extract-changelog task..."

# Create a test CHANGELOG.md
test_dir=$(mktemp -d)
trap 'rm -rf "$test_dir"' EXIT

cat > "$test_dir/CHANGELOG.md" << 'EOF'
# Changelog

All notable changes to this project will be documented in this file.

## 0.2.0 (2026-01-15)

- Added new feature X
- Improved performance Y
- Fixed bug Z

## 0.1.9 (2026-01-10)

- Another feature
- Another fix

## 0.1.8 (2026-01-05)

- Old feature
EOF

# Test extraction of version 0.2.0
cd "$test_dir"
export GITHUB_REF="refs/tags/v0.2.0"
bash /home/runner/work/frost/frost/.mise/tasks/release/extract-changelog > output.txt

# Verify the output contains expected lines
if grep -q "Added new feature X" output.txt && \
   grep -q "Improved performance Y" output.txt && \
   grep -q "Fixed bug Z" output.txt && \
   ! grep -q "Another feature" output.txt; then
  echo "✓ Test passed: Correctly extracted version 0.2.0"
else
  echo "✗ Test failed: Incorrect extraction"
  echo "Output was:"
  cat output.txt
  exit 1
fi

# Test extraction of version 0.1.9
export GITHUB_REF="refs/tags/v0.1.9"
bash /home/runner/work/frost/frost/.mise/tasks/release/extract-changelog > output.txt

if grep -q "Another feature" output.txt && \
   grep -q "Another fix" output.txt && \
   ! grep -q "Old feature" output.txt && \
   ! grep -q "Added new feature X" output.txt; then
  echo "✓ Test passed: Correctly extracted version 0.1.9"
else
  echo "✗ Test failed: Incorrect extraction"
  echo "Output was:"
  cat output.txt
  exit 1
fi

echo "All tests passed!"
