#!/usr/bin/env bash
#MISE description="Extract changelog section for the current release version"
#MISE sources=["CHANGELOG.md"]
#MISE outputs=["release_notes.txt"]
#USAGE arg "<changelog>" help="Path to CHANGELOG.md file" default="CHANGELOG.md"
set -euo pipefail

# The #USAGE directive above is a mise-specific annotation that parses command-line arguments.
# It makes the changelog path available as ${usage_changelog?} instead of using $1 directly,
# providing better integration with mise's argument parsing and validation.

# Get version from environment variable or GITHUB_REF
# VERSION takes priority over GITHUB_REF for explicit control in CI workflows.
#
# In the CD workflow, when checking out a specific tag (e.g., ref: "v0.1.10"),
# GITHUB_REF still reflects the original push event (refs/heads/main), not the
# checked-out tag. Therefore, we require the version to be passed explicitly
# via the VERSION environment variable in the workflow.
#
# The GITHUB_REF fallback is retained for local testing with tags.
if [ -n "${VERSION:-}" ]; then
  version="$VERSION"
elif [ -n "${GITHUB_REF:-}" ]; then
  version="${GITHUB_REF#refs/tags/v}"
else
  echo "Error: VERSION environment variable or GITHUB_REF must be set" >&2
  exit 1
fi

echo "Extracting changelog for version $version"

# Create temporary file for release notes
temp_file=$(mktemp)
trap 'rm -f "$temp_file"' EXIT

# Extract the section for this version from the specified changelog
awk -v version="$version" '
  /^## / {
    if (found) exit;
    if ($0 ~ version) {
      found=1;
      next;
    }
  }
  found && /^## / { exit }
  found { print }
' "${usage_changelog?}" > "$temp_file"

if [ ! -s "$temp_file" ]; then
  echo "Release v$version" > "$temp_file"
fi

# Copy to release_notes.txt for workflow
cat "$temp_file" > release_notes.txt
cat release_notes.txt
