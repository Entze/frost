#!/usr/bin/env bash
#MISE description="Insert new version header with current date into CHANGELOG.md"
set -euo pipefail

version=$(bump-my-version show current_version)
date=$(date +%Y-%m-%d)
header="## $version ($date)"

# Create temporary file
temp_file=$(mktemp)
trap 'rm --force "$temp_file"' EXIT

# Insert new version header before the first ## heading (or at end if none exist)
# This keeps the abstract before all version entries
awk -v header="$header" '
  !inserted && /^## / {
    print ""
    print header
    print ""
    inserted=1
  }
  { print }
  END {
    if (!inserted) {
      print ""
      print header
      print ""
    }
  }
' CHANGELOG.md > "$temp_file"
mv "$temp_file" CHANGELOG.md
