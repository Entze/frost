[tools]
hk = "1.28.0"
zig = "0.15.2"
pkl = "0.30.2"
action-validator = "0.8.0"
actionlint = "1.7.9"
"pipx:bump-my-version" = "1.2.5"

[tasks.build]
description = "Build all targets"
depends = ["build:*"]

[tasks."build:exe"]
description = "Build the executable"
usage = '''
flag "--optimize <mode>" help="Optimization profile" {
  choices "Debug" "ReleaseSafe" "ReleaseFast" "ReleaseSmall"
}
flag "--target <triple>" help="Target platform"
flag "--cpu <features>" help="CPU feature flags"
'''
run = "zig build exe --summary all{% if usage.optimize %} -Doptimize={{ usage.optimize }}{% endif %}{% if usage.target %} -Dtarget={{ usage.target }}{% endif %}{% if usage.cpu %} -Dcpu={{ usage.cpu }}{% endif %}"

[tasks."build:lib-static"]
description = "Build static library"
usage = '''
flag "--optimize <mode>" help="Optimization profile" {
  choices "Debug" "ReleaseSafe" "ReleaseFast" "ReleaseSmall"
}
flag "--target <triple>" help="Target platform"
flag "--cpu <features>" help="CPU feature flags"
'''
run = "zig build lib-static --summary all{% if usage.optimize %} -Doptimize={{ usage.optimize }}{% endif %}{% if usage.target %} -Dtarget={{ usage.target }}{% endif %}{% if usage.cpu %} -Dcpu={{ usage.cpu }}{% endif %}"

[tasks."build:lib-dynamic"]
description = "Build dynamic/shared library"
usage = '''
flag "--optimize <mode>" help="Optimization profile" {
  choices "Debug" "ReleaseSafe" "ReleaseFast" "ReleaseSmall"
}
flag "--target <triple>" help="Target platform"
flag "--cpu <features>" help="CPU feature flags"
'''
run = "zig build lib-dynamic --summary all{% if usage.optimize %} -Doptimize={{ usage.optimize }}{% endif %}{% if usage.target %} -Dtarget={{ usage.target }}{% endif %}{% if usage.cpu %} -Dcpu={{ usage.cpu }}{% endif %}"

[tasks.docs]
description = "Generate documentation"
run = "zig build docs --summary all"

[tasks.release]
description = "Build for all supported target platforms"
run = "zig build release --summary all"

[tasks.test]
depends = ["test:*"]

[tasks."test:zig"]
depends = ["test:zig:*"]

[tasks."test:zig:root"]
run = "zig test src/root.zig"

[tasks."test:zig:main"]
run = "zig test src/main.zig"

[tasks."test:zig:pattern"]
run = "zig test src/pattern.zig"

[tasks."test:mise"]
depends = ["test:mise:*"]

[tasks."test:mise:release"]
depends = ["test:mise:release:*"]

[tasks."test:mise:release:extract-changelog"]
run = "mise run release:test-extract-changelog"
run_windows = "echo Warning: test-extract-changelog test cannot run on Windows (requires bash) && exit 0"

[tasks."test:mise:release:changelog-version-new"]
run = "mise run release:test-changelog-version-new"
run_windows = "echo Warning: test-changelog-version-new test cannot run on Windows (requires bash) && exit 0"

[tasks.check]
usage = '''
arg "[paths]" var=#true
flag "--all"
'''
run = '''
{% if usage.all %}
hk check --all
{% else %}
hk check ${usage_paths}
{% endif %}
'''

[tasks.fix]
usage = '''
arg "[paths]" var=#true
flag "--all"
'''
run = '''
{% if usage.all %}
hk fix --all
{% else %}
hk fix ${usage_paths}
{% endif %}
'''

